--- 
layout: post
title: "Design Patterns: Template Method e Strategy em Ruby"
tags: 
- oo
- ruby
status: publish
type: post
published: true
meta: 
  _edit_last: "597486"
---
É interessante conhecer como outros programadores pensaram para solucionar casos que costumam se repetir durante o desenvolvimento de software. Alguns casos recorrentes foram catalogados em 1994 pela <a href="http://www.tml.tkk.fi/~pnr/GoF-models/html/">GoF, no livro sobre Design Patterns</a>. Vamos ver como aplicar alguns casos em Ruby.

Considere um sistema complexo onde em uma determinada parte do código existe a necessidade de uma variação. As vezes esse núcleo pode fazer uma coisa enquanto outra vez é necessário fazer outra. Para exemplificar melhor, vamos usar uma classe "Relatorio". Nosso relatório mostrará um conteúdo inicialmente em HTML.
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig12.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig12.png" alt="fig1" title="fig1" width="479" height="350" class="aligncenter size-full wp-image-226" /></a>

Vamos deixar de lado a questão do html na classe agora, apenas para efeito de análise do código. 

Nesse momento nossa classe gera apenas o relatório em um formato, mas voltando ao problemas que estamos resolvendo, temos a necessidade de criar o mesmo relatório porém em um formato diferente, por exemplo pdf ou texto puro mesmo.
O que fazer agora que é necessário um relatório em formato diferente ?
Bem...(rs)..uma abordagem poderia ser:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig21.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig21.png" alt="fig2" title="fig2" width="480" height="595" class="aligncenter size-full wp-image-229" /></a>

Bonito nao ? :)
Para solucionar esse problema de forma orientada a objetos poderiamos criar uma classe abstrata que define o comportamento de um relatório, ou seja, que define que um relatório de ter um head, um body, um footer, etc. Mas como criar uma classe abstrata em Ruby ? Embora não exista a palavra chave reservada "abstract" o conceito permanece presente na linguagem. Vejamos:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig31.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig31.png" alt="fig3" title="fig3" width="468" height="412" class="aligncenter size-full wp-image-230" /></a>


A classe Relatorio agora possui os métodos que definem um relatório. Obviamente esses métodos podem ser invocados. A solução para isso normalmente é lançar uma exception nesses métodos não implementados.
Agora que temos nossa classe abstrata, podemos criar subclasses de Relatorio que contém a implementação de cada um dos tipos, por exemplo para HTML:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig41.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig41.png" alt="fig4" title="fig4" width="394" height="470" class="aligncenter size-full wp-image-231" /></a>

E a implementação para Texto:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig51.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig51.png" alt="fig5" title="fig5" width="378" height="376" class="aligncenter size-full wp-image-232" /></a>

Agora para usar nossos relatórios podemos fazer:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig61.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig61.png" alt="fig6" title="fig6" width="317" height="102" class="aligncenter size-full wp-image-233" /></a>

Esse é o <strong>Template Method</strong>, um dos patterns que deram origem ao famos livro de Design Patterns do GoF.
Mas...um dos princípios mais discutidos em engenharia de software nãe era ..."<strong>Prefira composição ao invés de Herança</strong>" ?

<blockquote>HERANÇA!?!?!?!</blockquote>

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/esqueceram-de-mim.jpg"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/esqueceram-de-mim.jpg?w=291" alt="esqueceram-de-mim" title="esqueceram-de-mim" width="291" height="300" class="aligncenter size-full wp-image-212" /></a>


Compor e delegar são formas muito mais recomendadas de construir o design de uma aplicação. O que podemos fazer para melhorar nossa solução seguindo essas idéias ?
Primeiramente vamos parar de usar a classe relatório como uma superclasse, vamos refatorar o código e criar uma superclasse chamada "Formatter". Essa classe servirá para pensarmos em composição. Nossas implementações de relatórios agora ficam assim:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig71.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig71.png" alt="fig7" title="fig7" width="386" height="506" class="aligncenter size-full wp-image-235" /></a>


Agora podemos começar a pensar em composição. De volta a classe Relatorio, agora o "initalize" receberá um Formatter. Fica mais fácil imprimir um relatório agora, veja:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig81.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig81.png" alt="fig8" title="fig8" width="480" height="249" class="aligncenter size-full wp-image-236" /></a>

Agora para usar nossos relatórios podemos fazer:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig91.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig91.png" alt="fig9" title="fig9" width="371" height="47" class="aligncenter size-full wp-image-237" /></a>


Executar um núcleo diferente agora depende de como nosso objeto foi composto. O acoplamento agora é bem menor. Essa é a idéia do <strong>Strategy</strong>, tiramos a herança e favorecemos a composição, onde todos os objetos suportam 
suportam a mesma interface, mesmo que não exista a palavra chave reservada em ruby.

Mas da pra melhorar um pouco ainda, não ?
Repare no método "imprime_relatorio" da classe Relatorio. Esse método passa o titulo e o texto
para a implementação do relatório. Podemos melhorar isso passando uma referência do próprio objeto 
Relatório com self!

E pra melhorar um pouco mais e utilizar uma das características importantes do Ruby, podemos passar o conteúdo
do relatório através de blocos, tirando de vez a herança!
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/fig101.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/fig101.png" alt="fig10" title="fig10" width="480" height="526" class="aligncenter size-full wp-image-238" /></a>


Por mais que algumas palavras chaves da orientação a objetos não sejam explicitas no ruby, os conceitos estão muito presentes. 
Se você tiver alguma sugestão para melhorar o código acima, por favor, comente ou crie um <a href="http://gist.github.com/216387">fork do gist</a> do <a href="http://www.diegocarrion.com/">Diego Carrion</a> no github.
