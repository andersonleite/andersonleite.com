---
layout: post
title: "Clojure: Estados"
tags:
- clojure
status: publish
type: post
published: true
meta:
  _edit_last: "597486"
  jabber_published: "1283624199"
  _wp_old_slug: ""
image: closure2
---

<strong>A função hello criada anteriormente é pura. Isto significa que ela não tem nenhum efeito colateral. Esse tipo de função é relativamente fácil de escrever, testar e entender além de ser
recomendada pra diversas necessidades.</strong>

<br /><br />
Porém muitos programas possuem <span>estado compartilhado</span> e precisam de funções não puras como essa para manter esse estado compartilhado.

<br /><br />
<b>Melhorando a função hello</b><br />

Nossa função agora manterá um registro de todas as chamadas que forem feitas a ela. Para isso, usaremos um "<span>set</span>" do <span>Clojure</span>.

<code>#{}
⇒
#{}
</code>

Como adicionar elementos nesse <span>set</span> ? Para isso utilizaremos um "<span>conj</span>".
<span>Conj</span> é a significa conjoin de forma simplificada e ele cria novas coleções com os ítens adicionados.
Podemos então usar o <span>conj</span> com um elemento em um <span>set</span>.

<code>
(conj #{} "Anderson")
⇒
#{"Anderson"}

</code>
Agora que sabemos como criar "<strong>sets</strong>", precisamos de alguma forma manter os registros das chamadas a nossa função hello.
Para isso, <strong>Clojure</strong> possui referencias (<strong>refs</strong>) e para nomear uma referência usamos <strong>def</strong>.

<strong>def</strong> é quase igual ao <strong>defn</strong> mas de uma forma mais generalista. Usando <strong>def</strong> podemos definir funções ou dados.
Usamos <strong>def</strong> para criar referências e associá-las a nossa função:

<code>
(def visitors (ref #{}))
⇒
#'user/visitors
</code>


<br /><br />
<b>E onde está esse controle de estados tão forte em Closure ?</b><br />

<a href="http://andersonleiteblog.files.wordpress.com/2010/09/sharing-300x273.gif"><img src="http://andersonleiteblog.files.wordpress.com/2010/09/sharing-300x273.gif" alt="" title="sharing-300x273" width="300" height="273" class="alignnone size-full wp-image-631" /></a>

<br /><br />
O que acontece se tentarmos <span>alterar</span> essa referência que criamos ?
Vamos tentar fazer isso usando "<span>alter</span>". Usando "<span>alter</span>" podemos tentar alterar nossa referência, inclusive passando argumentos se necessário. Vamos tentar alterar "visitor" para "visitors".
<code>
(alter visitors conj "Anderson")
⇒
java.lang.IllegalStateException: No transaction running
</code>

<br /><br />
Como vemos acima, <span>clojure</span> protege as referências. Podemos alterá-las mas precisamos de "<span>transactions</span>", deixando para o <span>Clojure</span> o trabalho pesado de lidar com concorrêcia entre múltiplas chamadas a nossa função.


<br /><br />
E como crio essa <span>transaction</span> ?
Para criar uma <span>transaction</span> usamos <span>dosync</span>.

<code>(dosync (alter visitors conj "Anderson"))
⇒
#{"Anderson"}
</code>
Agora podemos buscar a referência com <span>deref</span>, veja:

<code>(deref visitors)
⇒
#{"Anderson"}
@visitors
⇒
#{"Anderson"}
</code>

<br /><br />
Agora podemos construir uma função hello muito mais avançada e elaborada:
 <code>(defn hello
    "Returns a hello message, calling you by username.
      Knows if you have been here before."
	[username]
	(dosync
		(let [past-visitor (@visitors username)]
			(if past-visitor
				(str "Welcome back, " username)
				(do
					(alter visitors conj username)
					(str "Hello, " username)))))) </code>
