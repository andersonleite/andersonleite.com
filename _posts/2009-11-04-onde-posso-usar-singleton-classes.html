--- 
layout: post
title: Onde posso usar Singleton Classes ?
tags: 
- rails
- ruby
status: publish
type: post
published: true
meta: 
  _edit_last: "597486"
image: onde
---
Há um tempo escrevi sobre <a href="http://andersonleiteblog.wordpress.com/2009/08/13/ruby-singleton-classes/">Ruby Singleton Classes</a>, já nesse post vou criar um plugin bem simples que facilita buscas no Rails e ver uma forma onde singleton classes podem ser úteis. 

Atualmente pra fazer uma busca ordenada precisamos fazer algo como:

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-13.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-13.png" alt="Picture 1" title="Picture 1" width="444" height="88" class="aligncenter size-full wp-image-352" /></a>
    A partir do momento que instalarmos nosso plugin na aplicação poderemos fazer a busca dessa forma:
    
<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-22.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-22.png" alt="Picture 2" title="Picture 2" width="412" height="124" class="aligncenter size-full wp-image-357" /></a>    
    
Nosso plugin não é nenhum idéia inovadora, mas sim uma necessidade ou problema onde precisaremos utilizar <strong>Singleton Classes</strong>. Vamos criar uma aplicação de exemplo para criar, instalar e usar o plugin:
<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-111.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-111.png" alt="Picture 11" title="Picture 11" width="359" height="197" class="aligncenter size-full wp-image-367" /></a>
Não vou colocar aqui toda a sequência para gerar a aplicação base, mas esse roteiro acima deve ajudar.

    Agora vamos comecar a gerar nosso plugin, vamos chamá-lo de <strong>default_options</strong>.Para iniciar basta rodar =&gt; <strong>  ruby script/generate plugin default_options</strong>




    <blockquote>Rails plugins e Singleton classes</blockquote>
    Agora é preciso adicionar um novo comportamento ao <strong>ActiveRecord</strong>, a necessidade do plugin é adicionar um método novo a base do ActiveRecord que mude seu comportamento padrão, para isso vamos utilizar <a href="http://andersonleiteblog.wordpress.com/2009/08/13/ruby-singleton-classes/">Ruby Singleton Classes</a>:
   
<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-41.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-41.png" alt="Picture 4" title="Picture 4" width="360" height="57" class="aligncenter size-full wp-image-359" /></a>
    Esse codigo abre a classe Base do módulo ActiveRecord e podemos adicionar qualquer novo comportamento nele.

    O objetivo agora é definir um comportamento default quando o método <strong>default_find_option</strong> for chamado.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-51.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-51.png" alt="Picture 5" title="Picture 5" width="480" height="164" class="aligncenter size-full wp-image-360" /></a>
Mas isso ainda não muda o comportamento do <em>find</em>, precisamos mesclar o find normal com os parametros passando pro nosso <strong>default_find_option</strong>. Pra isso vamos redefinir o find:

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-61.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-61.png" alt="Picture 6" title="Picture 6" width="480" height="162" class="aligncenter size-full wp-image-361" /></a>
    Quase bom, mas a chamada do find na última linha faz nosso código entrar em um loop infinito, vamos resolver isso da seguinte forma:

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-72.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-72.png" alt="Picture 7" title="Picture 7" width="448" height="144" class="aligncenter size-full wp-image-362" /></a>

    Agora podemos chamar nosso método adicionado ao ActiveRecord via plugin. Como teste podemos gerar alguns carrors com fixtures
    (test/fixtures/carros.yml):

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-82.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-82.png" alt="Picture 8" title="Picture 8" width="370" height="272" class="aligncenter size-full wp-image-363" /></a>
    E rodar alguns testes pro nosso plugin (test/unit/carro_test.rb):

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-92.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-92.png" alt="Picture 9" title="Picture 9" width="480" height="414" class="aligncenter size-full wp-image-364" /></a>


Não vou cobrir aqui como distribuir o plugin, isso fica pra um próximo post.
github =&gt; <a href="http://github.com/andersonleite/default_find_options">default_find_options</a>
