--- 
layout: post
title: "Design Patterns: Observer em Ruby"
tags: 
- oo
- ruby
status: publish
type: post
published: true
meta: 
  _edit_last: "597486"
---
Integração é um dos maiores desafios na construção de um sistema, cada 
alteração causada por determinada parte do código pode causar mudanças
no sistema com um todo. Em uma planilha, ao alterar uma célula, vários
outros objetos podem mudar, como uma atualização de uma conta ou 
recriar um gráfico. Manter esse tipo de integração não é simples, e alguns
padrões são voltados para diminuir esse tipo de acoplamento.

O Rails já implementa uma forma de atacar esse problema no próprio 
Active Record, fazendo <a href="http://andersonleiteblog.wordpress.com/2009/07/29/observer-no-rails/">callbacks na classe ActiveRecord::Observer</a>.


O código abaixo tenta demostrar uma implementação e solução desse problema.
Temos uma classe <strong>Funcionário</strong> e queremos manter avisados
todos os objetos do sistema que se interessem em modificações nele.


<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-1.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-1.png" alt="Picture 1" title="Picture 1" width="480" height="214" class="aligncenter size-full wp-image-260" /></a>


Agora vamos criar a classe <strong>Pagamento</strong>. Essa classe imprime um log a cada
vez que o salário do funcionário for alterado. Para isso, vamos laterar o 
initialize da classe Funcionario para receber também um obejeto do tipo 
Pagamento. Cada vez que o salário for alterado, agora chamanos o método
update do pagamento.


<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-21.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-21.png" alt="Picture 2" title="Picture 2" width="480" height="460" class="aligncenter size-full wp-image-279" /></a>

<strong>Mas e quando mais uma classe precisar ser informada das alterações no Funcionário ? </strong>
O código acima deixa as classe muito acompladas. Uma forma de diminnuir essa dependência pode ser criar uma lista de "observadores" ao criar o funcionário. Dessa forma poderiamos ingormar todos os objetos da lista quando uma alteração no funcionário for feita. Apenas precisamos aqui estabelecer uma interface, ou seja, todos os objetos que estão observando o funcionário terão o método <strong>update</strong> para serem notificados.

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-3.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-3.png" alt="Picture 3" title="Picture 3" width="480" height="485" class="aligncenter size-full wp-image-262" /></a>

Agora podemos facilmente adicionar um novo observador, veja:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-41.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-41.png" alt="Picture 4" title="Picture 4" width="480" height="233" class="aligncenter size-full wp-image-284" /></a>

Nossa implementação agora está boa, mas e quando precisarmos <em>observar um outro objeto do sistema</em> ? Precisariamos então copiar a mesma idéia nesse outro objeto.

Um objeto que está sendo observado é chamado de <strong>Subject</strong>.  Podemos resolver isso criando uma classe <em>Subject</em> que contém os métodos que adicionamos no Funcionario.


<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-5.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-5.png" alt="Picture 5" title="Picture 5" width="480" height="258" class="aligncenter size-full wp-image-264" /></a>

E usar herança nos objetos considerados Subject:
<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-6.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-6.png" alt="Picture 6" title="Picture 6" width="480" height="259" class="aligncenter size-full wp-image-265" /></a>


<blockquote>HERANÇA DE NOVO ! ? ! ?</blockquote>

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/alone1.jpg"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/alone1.jpg" alt="alone" title="alone" width="450" height="338" class="aligncenter size-full wp-image-266" /></a>


Vamos <em>dar preferência a composição ao invés da herança</em> visando diminuir o acoplamento entre nossas classes. Para isso vamos alterar a classe Subject para um <strong>Módulo</strong>.
Utilizando o módulo Subject como <strong>mixin</strong> melhoramos a implementação:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-7.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-7.png" alt="Picture 7" title="Picture 7" width="480" height="571" class="aligncenter size-full wp-image-268" /></a>

Essa é exatamente a idéia da classe <strong>Observer</strong> encontrada na documentação do Ruby:
    
<a href="http://ruby-doc.org/core/classes/Observable.html"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-8.png" alt="Picture 8" title="Picture 8" width="479" height="305" class="aligncenter size-full wp-image-269" /></a>

Portanto podemos incluir o próprio <strong>Observer</strong> do Ruby:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-9.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-9.png" alt="Picture 9" title="Picture 9" width="480" height="303" class="aligncenter size-full wp-image-270" /></a>



<strong>Melhorando o Observer usando blocos.</strong>

O método <strong>add_observer</strong> do Ruby não aceita blocos, mas podemos melhorar e solucionar isso aceitando <strong>blocos</strong> no módulo Subject que tinhamos criado anteriormente, chegando a uma implementação bem interessante de <strong>Observer</strong>:

<a href="http://andersonleiteblog.files.wordpress.com/2009/10/picture-10.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/10/picture-10.png" alt="Picture 10" title="Picture 10" width="480" height="631" class="aligncenter size-full wp-image-271" /></a>


<strong>Mais...</strong>
<a href="http://www.informit.com/articles/article.aspx?p=1404056">Entrevista com os autores do famoso livro do Gof, 15 anos depois de lançado:</a>

Se você tem alguma sugestão para melhorar o código acima comente ou crie um <a href="http://gist.github.com/218103">fork no github</a>.
