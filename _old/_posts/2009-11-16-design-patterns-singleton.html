--- 
layout: post
title: "Design patterns: Singleton"
tags: 
- rails
- ruby
status: publish
type: post
published: true
meta: 
  _edit_last: "597486"
image: singleton  
---
Todo mundo sabe dizer alguma coisa sobre Singletons. <b>Singleton é ruim, singleton é anti-pattern</b>. Mas como implemento um em Ruby e <b>por que não deveria utilizá-lo?</b>

O próprio Rails os utiliza por exemplo no <i>ActiveSupport</i> e em algumas tarefas do <i>Rake</i>. A motivação de um singleton está no fato de que algumas coisas são únicas.

Um singleton geralmente deixa pra própria classe gerenciar a criação do objeto. Antes de chegar na implementação do singleton vamos ver alguns comportamentos do ruby. 

Uma variável com um '@' é uma váriável de instância. Já uma variável com duas arrobas é uma variável de classe. Um método em ruby é da classe caso tenha o 'self' antes.  

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-14.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-14.png" alt="Picture 1" title="Picture 1" width="480" height="318" class="aligncenter size-full wp-image-385" /></a>

Podemos criar uma instância e incrementar tanto a variável de classe como a variável de instância.
Ao instanciar uma segunda vez, a variável de classe se mantém e a de instância é obviamente 'zerada'.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-23.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-23.png" alt="Picture 2" title="Picture 2" width="480" height="144" class="aligncenter size-full wp-image-386" /></a>

Utilizando a idéia acima podemos criar uma classe simples de log, onde desejamos que apenas uma  seja de fato criada. Para isso definiremos o método 'instance' como método de classe que sempre retorna a mesma instancia da classe, guardada pela variável de classe "@@instance"

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-33.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-33.png" alt="Picture 3" title="Picture 3" width="480" height="162" class="aligncenter size-full wp-image-387" /></a>

Quase funcionando, porém ainda poderíamos instanciar a classe de log...Pra evitar isso podemos usar o metodo 'private_class_method' passado como parâmetro méthodo 'new'.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-42.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-42.png" alt="Picture 4" title="Picture 4" width="480" height="173" class="aligncenter size-full wp-image-388" /></a>

A implementação do singleton está completa. A classe cria apenas uma instância dela mesma, não permitindo nunca a criação de uma segunda.

Mas..e se fosse necessário mais um singleton na aplicação ?  Teríamos que repetir esse processo inteiro.

O ruby fornece uma alternativa a isso que é incluir o módulo 'singleton'.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-52.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-52.png" alt="Picture 5" title="Picture 5" width="480" height="98" class="aligncenter size-full wp-image-389" /></a>

Uma chamada a Logger.instance devolve a uma única intância sempre da mesma maneira que a implementação anterior.

<blockquote>eager instantiation x lazy</blockquote>
Existe uma diferença entre o singleton que construímos e o módulo singleton do ruby.

Na nossa implementação do singleton a instância é criada antes de qualquer chamada a Logger.instance. Criar uma instancia antes mesmo antes que ninguém necessite é chamado de <strong>'eager instantiation'</strong>. Já a forma utilizada no módulo singleton espera pela primeira invocação para criar a instância, essa chamada é a conhecida como <strong>'lazy instatiation'</strong>.

<blockquote>Variáveis globais x Singletons</blockquote>
Podemos, por exemplo, utilizar uma variável global como singleton. E é aqui que o negócio começa a ficar feio. Em Ruby, qualquer variável iniciada com '$' é global, você pode acessar de qualquer lugar. Portanto essa poderia ser uma boa implementação para singletons. 

<strong>NÃO</strong>. Não existe nada que controle o calor da variável global nese caso como fizemos com o singleton, além das variáveis globais serem impossíveis de serem criadas antes(eager instatiation). Além disso não existem nada que garanta que essa variável não seja recriada e substituída em outro lugar.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-62.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-62.png" alt="Picture 6" title="Picture 6" width="480" height="54" class="aligncenter size-full wp-image-390" /></a>

É por isso que em ruby <b>um singleton é implementado como um módulo</b>. Como não é possível implementar um módulo seus métodos claramentes são criados para serem chamados sem permitir a criação de um objeto.


<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-73.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-73.png" alt="Picture 7" title="Picture 7" width="479" height="154" class="aligncenter size-full wp-image-392" /></a>

Agora nunca mais teremos mais de uma instância da classe Gerenciador. Ainda não... Ainda seria possível utilizar o método <b>clone</b> do Ruby.
  
<a href="http://andersonleiteblog.files.wordpress.com/2009/11/picture-83.png"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/picture-83.png" alt="Picture 8" title="Picture 8" width="480" height="54" class="aligncenter size-full wp-image-393" /></a>  
  
Não que isso seja uma boa idéia, mas mostra como Ruby é uma linguagem onde praticamente tudo pode ser mudado em tempo de execução. A filosofia do Ruby é que se você decide que realmente precisa de uma implementação diferenta da craida anteriormente, a linguagem e permitirá isso, fica a seu critério e a sua responsabilidade.

<a href="http://andersonleiteblog.files.wordpress.com/2009/11/homealone.jpg"><img src="http://andersonleiteblog.files.wordpress.com/2009/11/homealone.jpg" alt="homealone" title="homealone" width="400" height="300" class="aligncenter size-full wp-image-394" /></a> 

<blockquote>Singleton: Anti-pattern</blockquote>
Um singleton sempre será basicamente uma variável única de escopo global. Com isso você cria um <b>canal de comunicação direto entre qualquer classe</b> com o singleton, deixando <b>totalmente acomplado</b> o relacionamento entre eles. 

Outro problema é a <b>dificuldade de se fazer testes unitários</b> quando sua implementação se relaciona com um singleton. Como o estado pode sempre variar, seus testes terão ganho uma complexidade maior do que a necessária.

A recomendação então é: <strong>Não use singleton! </strong>Singletons propriamente aplicados são executados apenas uma vez, mas mesmo assim, não use singleton! 
